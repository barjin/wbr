<!DOCTYPE html>
<html>
   <head><title>wbr-cloud menu</title></head>
   <script>
      let workflows = [];

      function spawnRunner(id){
         let params = workflows.find(wf => wf.idx === id).params;
         const initParams = params.reduce((prev,newName) => (
            {...prev, [newName]: prompt(`Set value of parameter ${newName}:`)}
         ), {});

         if(!Object.values(initParams).every(x => x)){
            return;
         }

         fetch('/performer', 
         {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json'
            },
            body: JSON.stringify({
               id: id,
               params: initParams
            })
         }).then(() => {
            window.location.reload();
         });
      }

      function fetchRecordings(){
         const table = document.getElementById('workflows');
         fetch('/workflow')
            .then(x => x.json())
            .then(list => {
               workflows = list;
               list.forEach(workflow => {
                  var row = table.insertRow(1);

                  row.insertCell(0).innerHTML = workflow.cname ?? workflow.filename;
                  row.insertCell(1).innerHTML = `<button onClick="spawnRunner(${workflow.idx})">Spawn runner</button>`;
               })
            });
      }

      function fetchPerformers(){
         const table = document.getElementById('runners');
         fetch('/performer')
            .then(x => x.json())
            .then(list => {
               list.forEach(workflow => {
                  var row = table.insertRow(1);

                  row.insertCell(0).innerHTML = workflow.state !== "FINISHED" ? `<a href="/performer/${workflow.url.substring(1)}">${workflow.url}</a>` : workflow.url;
                  row.insertCell(1).innerHTML = workflow.state;
               })
            });
      }


      document.addEventListener('DOMContentLoaded', () => {
         fetchRecordings();
         fetchPerformers();
      });

   </script>
   <body>
   <table id="workflows">
      <tr><th>Workflows</th></tr>
   </table>
   <form action="workflow" method="post" enctype="multipart/form-data">
      Upload new workflow:
      <input type="file" name="workflow" id="workflow">
      <input type="submit" value="Upload workflow" name="submit">
   </form>
   <span>All the default workflows are available in the <a href="https://github.com/barjin/wbr/packages/wbr-cloud/examples">GitHub repo.</a></span>
   <table id="runners">
      <tr><th>Runners</th></tr>
   </table>
   </body>
 </html>