<!DOCTYPE html>
<html>
   <head><title>Hello world</title></head>
   <script src="http://localhost:3000/socket.io/socket.io.js"></script>
   <script>
      function connectToRunner(){
         const urlSearchParams = new URLSearchParams(window.location.search);
         const params = Object.fromEntries(urlSearchParams.entries());
         if(params.id){
            var socket = io(`/${params.id}`);
            socket.on('screen',(a) => drawToCanvas(a.data));
         }
      }

      function drawToCanvas(image){
         console.log(image);
         const canvas = document.getElementById('screen');
         if (canvas) {
            const ctx = canvas.getContext('2d');

            const img = new Image();

            img.src = `data:image/jpg;base64,${image}`;
            img.onload = () => {
               URL.revokeObjectURL(img.src);
               ctx?.clearRect(0, 0, canvas.width, canvas.height);
               ctx?.drawImage(img, 0, 0);
            };
         }
      }

      function spawnRunner(id){
         fetch('/performer', 
         {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json'
            },
            body: JSON.stringify({id: id})
         }).then(() => {
            window.location.reload();
         });
      }

      function fetchRecordings(){
         const table = document.getElementById('workflows');
         fetch('/workflow')
            .then(x => x.json())
            .then(list => {
               list.forEach(workflow => {
                  var row = table.insertRow(1);

                  row.insertCell(0).innerHTML = workflow.name;
                  row.insertCell(1).innerHTML = `<button onClick="spawnRunner(${workflow.idx})">Spawn runner</button>`;
               })
            });
      }

      function fetchPerformers(){
         const table = document.getElementById('runners');
         fetch('/performer')
            .then(x => x.json())
            .then(list => {
               list.forEach(workflow => {
                  var row = table.insertRow(1);

                  row.insertCell(0).innerHTML = workflow.state === "NEW" ? `<a href="/?id=${workflow.url.substring(1)}">${workflow.url}</a>` : workflow.url;
                  row.insertCell(1).innerHTML = workflow.state;
               })
            });
      }


      document.addEventListener('DOMContentLoaded', () => {
         fetchRecordings();
         fetchPerformers();
         connectToRunner();
      });

   </script>
   <body>
   <canvas id='screen' width="1280" height="720">
   </canvas>
   <table id="workflows">
      <tr><th>Workflows</th></tr>
   </table>
   <form action="workflow" method="post" enctype="multipart/form-data">
      Upload new workflow:
      <input type="file" name="workflow" id="workflow">
      <input type="submit" value="Upload workflow" name="submit">
   </form>
   <table id="runners">
      <tr><th>Runners</th></tr>
   </table>
   </body>
 </html>